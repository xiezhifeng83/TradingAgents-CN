# TradingAgents-CN 部署运维手册

> **文档版本**: v1.0
> **项目版本**: v1.0.0-preview
> **编制日期**: 2026-02-11

---

## 1. 环境要求

### 1.1 硬件要求

| 环境 | CPU | 内存 | 磁盘 | 网络 |
|------|-----|------|------|------|
| 最低配置 | 2核 | 4GB | 20GB | 可访问外网 |
| 推荐配置 | 4核 | 8GB | 50GB | 可访问外网 |
| 生产环境 | 8核 | 16GB | 100GB SSD | 可访问外网 |

### 1.2 软件要求

| 软件 | 版本要求 | 说明 |
|------|---------|------|
| Docker | ≥24.0 | 容器运行时 |
| Docker Compose | ≥2.20 | 容器编排 |
| Python | ≥3.10 (仅CLI/开发) | 开发环境 |
| Node.js | ≥18.0 (仅前端开发) | 前端开发环境 |
| Git | ≥2.30 | 代码管理 |

### 1.3 网络要求

| 服务 | 地址 | 用途 |
|------|------|------|
| LLM API | api.deepseek.com / api.openai.com 等 | AI推理 |
| 数据源 API | 各数据源服务器 | 金融数据 |
| PyPI / npm | pypi.org / registry.npmjs.org | 依赖安装 |

---

## 2. Docker 部署（推荐）

### 2.1 快速部署

```bash
# 1. 克隆项目
git clone https://github.com/hsliuping/TradingAgents-CN.git
cd TradingAgents-CN

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env 文件，填入必需配置

# 3. 一键启动
docker compose up -d

# 4. 检查服务状态
docker compose ps

# 5. 查看日志
docker compose logs -f
```

### 2.2 环境变量配置

编辑 `.env` 文件，至少配置以下项：

```bash
# ========== 必需配置 ==========

# MongoDB 数据库
MONGODB_HOST=mongodb
MONGODB_PORT=27017
MONGODB_USERNAME=admin
MONGODB_PASSWORD=<设置强密码>
MONGODB_DATABASE=tradingagents

# Redis 缓存
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=<设置强密码>

# JWT 认证密钥
JWT_SECRET=<随机生成的长字符串>

# ========== LLM 配置（至少配置一个）==========

# DeepSeek（推荐，性价比高）
DEEPSEEK_API_KEY=<你的API Key>

# 或 OpenAI
# OPENAI_API_KEY=<你的API Key>

# 或 阿里百炼
# DASHSCOPE_API_KEY=<你的API Key>

# ========== 数据源配置（可选）==========

# Tushare（专业数据，推荐）
# TUSHARE_TOKEN=<你的Token>

# FinnHub
# FINNHUB_API_KEY=<你的API Key>
```

### 2.3 服务管理

```bash
# 启动所有服务
docker compose up -d

# 停止所有服务
docker compose down

# 重启特定服务
docker compose restart backend

# 查看服务日志
docker compose logs -f backend
docker compose logs -f frontend

# 查看资源使用
docker compose stats
```

### 2.4 数据持久化

Docker Compose 自动创建数据卷：

| 卷名 | 挂载路径 | 用途 |
|------|---------|------|
| mongodb_data | /data/db | MongoDB 数据文件 |
| redis_data | /data | Redis 持久化数据 |

```bash
# 查看数据卷
docker volume ls

# 备份 MongoDB 数据
docker compose exec mongodb mongodump --out /dump
docker cp tradingagents-mongodb:/dump ./backup/

# 恢复 MongoDB 数据
docker cp ./backup/dump tradingagents-mongodb:/dump
docker compose exec mongodb mongorestore /dump
```

---

## 3. 本地开发部署

### 3.1 后端开发环境

```bash
# 1. 创建虚拟环境
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# .venv\Scripts\activate   # Windows

# 2. 安装依赖
pip install -r requirements.txt
pip install -e .

# 3. 配置环境变量
cp .env.example .env
# 编辑 .env

# 4. 启动 MongoDB 和 Redis（Docker）
docker compose up -d mongodb redis

# 5. 启动后端
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 3.2 前端开发环境

```bash
# 1. 进入前端目录
cd frontend

# 2. 安装依赖
npm install

# 3. 启动开发服务器
npm run dev

# 4. 构建生产版本
npm run build
```

### 3.3 CLI 使用

```bash
# 基本用法
python -m cli.main "<股票代码>" <LLM提供商>

# 示例
python -m cli.main "600036" deepseek
python -m cli.main "AAPL" openai
python -m cli.main "00700.HK" google
```

---

## 4. 运维操作

### 4.1 日常巡检

```bash
# 1. 检查服务状态
docker compose ps

# 2. 检查磁盘空间
df -h

# 3. 检查 MongoDB 状态
docker compose exec mongodb mongosh --eval "db.serverStatus()"

# 4. 检查 Redis 状态
docker compose exec redis redis-cli INFO

# 5. 检查应用日志是否有ERROR
docker compose logs --since 1h backend | grep ERROR
```

### 4.2 日志管理

| 日志位置 | 说明 |
|---------|------|
| `docker compose logs backend` | 后端应用日志 |
| `docker compose logs frontend` | 前端/Nginx日志 |
| `docker compose logs mongodb` | 数据库日志 |
| `docker compose logs redis` | 缓存日志 |

```bash
# 查看最近100行日志
docker compose logs --tail 100 backend

# 实时跟踪日志
docker compose logs -f backend

# 按时间筛选
docker compose logs --since 2h backend
```

### 4.3 数据库维护

```bash
# 连接 MongoDB Shell
docker compose exec mongodb mongosh -u admin -p <密码>

# 查看数据库大小
use tradingagents
db.stats()

# 查看集合统计
db.analysis_tasks.stats()

# 清理30天前的操作日志（如TTL索引未生效）
db.operation_logs.deleteMany({
  created_at: { $lt: new Date(Date.now() - 30*24*60*60*1000) }
})

# 重建索引
db.analysis_tasks.reIndex()
```

### 4.4 Redis 维护

```bash
# 连接 Redis CLI
docker compose exec redis redis-cli

# 查看内存使用
INFO memory

# 查看键数量
DBSIZE

# 清理过期缓存
# Redis 自动清理过期键，一般无需手动操作

# 紧急情况：清空所有缓存
FLUSHALL
```

### 4.5 备份策略

```bash
#!/bin/bash
# backup.sh - 定时备份脚本

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/opt/backups/tradingagents"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份 MongoDB
docker compose exec -T mongodb mongodump \
  --archive=/tmp/mongo_${DATE}.gz \
  --gzip
docker cp tradingagents-mongodb:/tmp/mongo_${DATE}.gz $BACKUP_DIR/

# 备份 Redis
docker compose exec redis redis-cli BGSAVE
docker cp tradingagents-redis:/data/dump.rdb $BACKUP_DIR/redis_${DATE}.rdb

# 备份环境配置
cp .env $BACKUP_DIR/env_${DATE}

# 清理7天前的备份
find $BACKUP_DIR -mtime +7 -delete

echo "备份完成: $BACKUP_DIR"
```

---

## 5. 故障排查

### 5.1 常见问题

#### 问题1：后端启动失败

```bash
# 检查日志
docker compose logs backend

# 常见原因：
# 1. MongoDB/Redis 未就绪 → 等待数据库启动后重试
docker compose restart backend

# 2. 环境变量缺失 → 检查 .env 文件
docker compose exec backend env | grep MONGODB

# 3. 端口占用
netstat -tlnp | grep 8000
```

#### 问题2：LLM 调用失败

```
# 检查 API Key 配置
docker compose exec backend env | grep API_KEY

# 检查网络连通性
docker compose exec backend curl -s https://api.deepseek.com/health

# 检查日志中的具体错误
docker compose logs backend | grep "LLM"
```

#### 问题3：数据源无法访问

```bash
# 检查网络
docker compose exec backend curl -s https://tushare.pro

# 检查 Token 配置
docker compose exec backend env | grep TUSHARE

# 系统会自动降级到备选数据源，检查降级日志
docker compose logs backend | grep "降级\|fallback"
```

#### 问题4：MongoDB 连接失败

```bash
# 检查 MongoDB 容器状态
docker compose ps mongodb

# 检查连接参数
docker compose exec backend python -c "
from app.core.database import get_database
import asyncio
asyncio.run(get_database())
"

# 重启 MongoDB
docker compose restart mongodb
```

### 5.2 性能问题排查

```bash
# 检查容器资源使用
docker stats

# MongoDB 慢查询日志
docker compose exec mongodb mongosh --eval "
  db.setProfilingLevel(1, { slowms: 100 })
"

# Redis 慢日志
docker compose exec redis redis-cli SLOWLOG GET 10

# 后端性能指标
curl http://localhost:8000/health
```

---

## 6. 版本升级

### 6.1 升级步骤

```bash
# 1. 备份数据
./backup.sh

# 2. 拉取新版本
git pull origin main

# 3. 重新构建镜像
docker compose build

# 4. 滚动更新
docker compose up -d

# 5. 验证服务
docker compose ps
curl http://localhost:8000/health
```

### 6.2 回滚操作

```bash
# 1. 停止当前版本
docker compose down

# 2. 回滚代码
git checkout <previous-tag>

# 3. 重建并启动
docker compose build
docker compose up -d

# 4. 如需恢复数据
# 参考 4.5 备份策略中的恢复步骤
```

---

## 7. 安全加固

### 7.1 生产环境安全检查清单

- [ ] 修改所有默认密码（MongoDB、Redis、JWT Secret）
- [ ] 配置 HTTPS（Nginx SSL 证书）
- [ ] 限制 MongoDB/Redis 不对外暴露端口
- [ ] 设置防火墙规则
- [ ] 启用 API 速率限制
- [ ] 定期更新依赖包
- [ ] 配置日志轮转，防止磁盘满
- [ ] 设置监控报警

### 7.2 端口安全

```yaml
# docker-compose.yml 生产配置建议
services:
  mongodb:
    ports: []  # 不暴露到宿主机
  redis:
    ports: []  # 不暴露到宿主机
  frontend:
    ports:
      - "443:443"   # 仅暴露 HTTPS
```
