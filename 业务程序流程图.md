# TradingAgents-CN 业务程序流程图

> **文档版本**: v1.0
> **项目版本**: v1.0.0-preview
> **编制日期**: 2026-02-11

---

## 1. 系统总体流程

```mermaid
graph TD
    A[用户] -->|Web界面| B[Vue 3 前端]
    A -->|命令行| C[CLI 工具]
    A -->|HTTP请求| D[REST API]

    B -->|Axios| E[FastAPI 后端]
    C -->|直接调用| F[核心框架]
    D --> E

    E -->|调用| F[TradingAgents 核心框架]
    E -->|读写| G[(MongoDB)]
    E -->|缓存| H[(Redis)]

    F -->|编排| I[LangGraph 工作流]
    F -->|数据| J[数据管道]
    F -->|推理| K[LLM 适配器]

    J -->|API调用| L[外部数据源]
    K -->|API调用| M[LLM 服务]

    style A fill:#e1f5fe
    style F fill:#fff3e0
    style G fill:#e8f5e9
    style H fill:#fce4ec
```

---

## 2. 核心分析流程

### 2.1 单股分析全流程

```mermaid
graph TD
    START([开始]) --> INPUT[用户输入股票代码]
    INPUT --> DETECT{识别市场类型}

    DETECT -->|6位数字| ASHARE[A股市场]
    DETECT -->|.HK后缀| HKSTOCK[港股市场]
    DETECT -->|字母代码| USSTOCK[美股市场]

    ASHARE --> SELECT_DS[选择数据源]
    HKSTOCK --> SELECT_DS
    USSTOCK --> SELECT_DS

    SELECT_DS --> PHASE1[Phase 1: 并行数据分析]

    subgraph "Phase 1: 数据采集与分析"
        PHASE1 --> MA[市场分析师<br/>技术面分析]
        PHASE1 --> FA[基本面分析师<br/>财务分析]
        PHASE1 --> NA[新闻分析师<br/>舆情分析]
        PHASE1 --> SA[社交媒体分析师<br/>情绪分析]
    end

    MA --> PHASE1_DONE[四份分析报告汇合]
    FA --> PHASE1_DONE
    NA --> PHASE1_DONE
    SA --> PHASE1_DONE

    PHASE1_DONE --> PHASE2[Phase 2: 辩证研究]

    subgraph "Phase 2: 多角度研究"
        PHASE2 --> BULL[看涨研究员<br/>寻找利好证据]
        PHASE2 --> BEAR[看跌研究员<br/>寻找利空风险]
    end

    BULL --> PHASE2_DONE[研究报告汇合]
    BEAR --> PHASE2_DONE

    PHASE2_DONE --> PLAN[Phase 3: 生成投资计划]

    PLAN --> PHASE4[Phase 4: 风险辩论]

    subgraph "Phase 4: 风险评估辩论"
        PHASE4 --> CONS[保守派论者<br/>强调风险]
        CONS --> NEUT[中立派论者<br/>平衡分析]
        NEUT --> AGGR[激进派论者<br/>追求收益]
        AGGR --> CHECK{辩论轮数<br/>是否达上限?}
        CHECK -->|否| CONS
        CHECK -->|是| RM[风险经理汇总]
    end

    RM --> TRADER[Phase 5: 交易员决策]

    TRADER --> OUTPUT[输出投资建议]
    OUTPUT --> SAVE[保存结果到数据库]
    SAVE --> NOTIFY[推送通知给用户]
    NOTIFY --> END_NODE([结束])

    style PHASE1 fill:#e3f2fd
    style PHASE2 fill:#f3e5f5
    style PLAN fill:#fff8e1
    style PHASE4 fill:#fbe9e7
    style TRADER fill:#e8f5e9
```

### 2.2 数据源降级流程

```mermaid
graph TD
    REQ[数据请求] --> L1{L1 Redis<br/>缓存命中?}

    L1 -->|命中| RET1[返回缓存数据]
    L1 -->|未命中| L2{L2 MongoDB<br/>缓存命中?}

    L2 -->|命中| FILL1[回填 Redis] --> RET2[返回数据]
    L2 -->|未命中| L3{L3 文件<br/>缓存命中?}

    L3 -->|命中| FILL2[回填 Redis+MongoDB] --> RET3[返回数据]
    L3 -->|未命中| DS1{主数据源<br/>可用?}

    DS1 -->|可用| FETCH1[获取数据] --> CACHE[写入三级缓存] --> RET4[返回数据]
    DS1 -->|不可用| DS2{备选数据源1<br/>可用?}

    DS2 -->|可用| FETCH2[获取数据] --> CACHE
    DS2 -->|不可用| DS3{备选数据源2<br/>可用?}

    DS3 -->|可用| FETCH3[获取数据] --> CACHE
    DS3 -->|不可用| ERR[抛出数据源异常]

    style L1 fill:#ffcdd2
    style L2 fill:#c8e6c9
    style L3 fill:#bbdefb
    style DS1 fill:#fff9c4
    style DS2 fill:#fff9c4
    style DS3 fill:#fff9c4
```

---

## 3. Web 应用流程

### 3.1 用户认证流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端 (Vue)
    participant B as 后端 (FastAPI)
    participant DB as MongoDB
    participant R as Redis

    U->>F: 输入用户名/密码
    F->>B: POST /api/auth/login
    B->>DB: 查询用户记录
    DB-->>B: 返回用户数据
    B->>B: bcrypt 密码验证
    alt 验证成功
        B->>B: 生成 JWT Token
        B-->>F: 200 {token, user_info}
        F->>F: 存储 Token (localStorage)
        F-->>U: 跳转到首页
    else 验证失败
        B-->>F: 401 认证失败
        F-->>U: 显示错误提示
    end
```

### 3.2 单股分析请求流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant B as 后端
    participant Q as 队列服务
    participant E as 分析引擎
    participant DB as MongoDB
    participant WS as WebSocket/SSE

    U->>F: 输入股票代码，点击分析
    F->>B: POST /api/analysis/single {ticker, config}
    B->>B: 验证 JWT Token
    B->>DB: 创建分析任务 (status: pending)
    B->>Q: 加入分析队列
    B-->>F: 202 {task_id}
    F->>WS: 订阅任务进度

    Q->>E: 取出任务执行
    E->>DB: 更新状态 (status: running)
    E->>WS: 推送: 开始分析

    loop 各阶段分析
        E->>E: 执行分析师/研究员/辩论
        E->>WS: 推送: 阶段进度
    end

    E->>DB: 保存分析结果
    E->>DB: 更新状态 (status: completed)
    E->>WS: 推送: 分析完成

    WS-->>F: 接收完成通知
    F->>B: GET /api/analysis/{task_id}
    B->>DB: 查询分析结果
    B-->>F: 200 {完整分析报告}
    F-->>U: 展示分析结果
```

### 3.3 报告导出流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant B as 后端
    participant DB as MongoDB
    participant G as 报告生成器

    U->>F: 选择报告格式 (MD/Word/PDF)
    F->>B: GET /api/reports/{id}/{format}
    B->>DB: 查询分析结果
    DB-->>B: 返回完整分析数据
    B->>G: 生成报告

    alt Markdown
        G->>G: 模板渲染 Markdown
    else Word
        G->>G: python-docx 生成 .docx
    else PDF
        G->>G: pdfkit 生成 .pdf
    end

    G-->>B: 返回文件流
    B-->>F: 文件下载响应
    F-->>U: 浏览器下载报告
```

---

## 4. 数据同步流程

### 4.1 定时数据同步

```mermaid
graph TD
    SCHED[APScheduler 定时触发] --> CHECK{当前是否<br/>交易时段?}

    CHECK -->|是| SKIP[跳过本次同步]
    CHECK -->|否| START_SYNC[开始数据同步]

    START_SYNC --> TUSHARE[Tushare 同步]
    START_SYNC --> AKSHARE[AKShare 同步]
    START_SYNC --> BAOSTOCK[BaoStock 同步]

    subgraph "Tushare 同步流程"
        TUSHARE --> T1[获取股票列表]
        T1 --> T2[分批获取行情数据]
        T2 --> T3[更新 MongoDB]
    end

    subgraph "AKShare 同步流程"
        AKSHARE --> A1[获取股票列表]
        A1 --> A2[分批获取行情数据]
        A2 --> A3[更新 MongoDB]
    end

    subgraph "BaoStock 同步流程"
        BAOSTOCK --> B1[获取股票列表]
        B1 --> B2[分批获取行情数据]
        B2 --> B3[更新 MongoDB]
    end

    T3 --> DONE[同步完成]
    A3 --> DONE
    B3 --> DONE

    DONE --> LOG[记录同步日志]
    DONE --> NOTIFY[推送同步完成通知]
```

---

## 5. CLI 执行流程

```mermaid
graph TD
    CMD[python -m cli.main<br/>"600036" deepseek] --> PARSE[解析命令行参数]

    PARSE --> LOAD_ENV[加载环境变量 .env]
    LOAD_ENV --> INIT_CONFIG[初始化配置]
    INIT_CONFIG --> INIT_GRAPH[初始化 TradingAgentsGraph]

    INIT_GRAPH --> INIT_LLM[初始化 LLM 客户端]
    INIT_LLM --> INIT_DATA[初始化数据管道]
    INIT_DATA --> BUILD_GRAPH[构建 LangGraph 工作流图]

    BUILD_GRAPH --> PROPAGATE[执行前向传播<br/>propagate]

    subgraph "前向传播"
        PROPAGATE --> P_ANALYSTS[执行四个分析师]
        P_ANALYSTS --> P_RESEARCHERS[执行研究员辩论]
        P_RESEARCHERS --> P_PLAN[生成投资计划]
        P_PLAN --> P_RISK[风险辩论]
        P_RISK --> P_TRADER[交易员决策]
    end

    P_TRADER --> REFLECT[执行反思学习<br/>reflect]

    subgraph "反思学习"
        REFLECT --> R_MEMORY[检索历史记忆]
        R_MEMORY --> R_IMPROVE[基于历史改进分析]
    end

    R_IMPROVE --> SIGNAL[信号处理]
    SIGNAL --> OUTPUT_CLI[输出投资建议到终端]
    OUTPUT_CLI --> END_CLI([结束])

    style PROPAGATE fill:#e3f2fd
    style REFLECT fill:#f3e5f5
    style SIGNAL fill:#e8f5e9
```

---

## 6. 智能体内部流程

### 6.1 单个分析师工作流程

```mermaid
graph TD
    INPUT[接收 AgentState] --> GET_DATA[调用数据接口<br/>获取领域数据]

    GET_DATA --> CHECK_DATA{数据获取<br/>成功?}

    CHECK_DATA -->|成功| BUILD_PROMPT[构建 LLM Prompt<br/>注入数据 + 分析指令]
    CHECK_DATA -->|失败| FALLBACK[使用降级数据<br/>或空数据标注]

    FALLBACK --> BUILD_PROMPT

    BUILD_PROMPT --> CALL_LLM[调用 LLM 推理]

    CALL_LLM --> CHECK_LLM{LLM 调用<br/>成功?}

    CHECK_LLM -->|成功| PARSE[解析 LLM 响应]
    CHECK_LLM -->|失败| RETRY{重试次数<br/>< 3?}

    RETRY -->|是| CALL_LLM
    RETRY -->|否| ERROR[生成错误报告]

    PARSE --> UPDATE[更新 AgentState<br/>写入分析报告]
    ERROR --> UPDATE

    UPDATE --> OUTPUT[返回更新后的 AgentState]

    style GET_DATA fill:#e3f2fd
    style CALL_LLM fill:#fff3e0
    style UPDATE fill:#e8f5e9
```

### 6.2 风险辩论循环流程

```mermaid
graph TD
    INPUT[投资计划输入] --> INIT[辩论轮数 = 0]

    INIT --> CONS[保守派发言]
    CONS --> CONS_THINK[分析风险因素<br/>提出担忧]

    CONS_THINK --> NEUT[中立派发言]
    NEUT --> NEUT_THINK[平衡分析<br/>综合利弊]

    NEUT_THINK --> AGGR[激进派发言]
    AGGR --> AGGR_THINK[论证收益潜力<br/>反驳过度担忧]

    AGGR_THINK --> INC[辩论轮数 + 1]
    INC --> CHECK{轮数 >= <br/>max_debate_rounds?}

    CHECK -->|否| CONS
    CHECK -->|是| SUMMARY[风险经理汇总]

    SUMMARY --> ASSESS[生成风险评估报告<br/>包含三派共识与分歧]

    ASSESS --> OUTPUT[输出风险评估]

    style CONS fill:#ffcdd2
    style NEUT fill:#fff9c4
    style AGGR fill:#c8e6c9
    style SUMMARY fill:#bbdefb
```

---

## 7. LLM 调用流程

```mermaid
graph TD
    REQ[LLM 调用请求] --> SELECT{选择 LLM 提供商}

    SELECT -->|OpenAI| OAI[OpenAI API]
    SELECT -->|DeepSeek| DS[DeepSeek Adapter]
    SELECT -->|Google| GG[Google Adapter]
    SELECT -->|阿里百炼| ALI[DashScope Adapter]
    SELECT -->|聚合渠道| AGG[OpenAI Compatible]

    OAI --> CALL[发送推理请求]
    DS --> CALL
    GG --> CALL
    ALI --> CALL
    AGG --> CALL

    CALL --> CHECK{调用成功?}

    CHECK -->|成功| PARSE_RESP[解析响应]
    CHECK -->|失败| RETRY{重试?}

    RETRY -->|是| CALL
    RETRY -->|否| ERROR_LLM[返回错误]

    PARSE_RESP --> HAS_TOOLS{包含工具调用?}

    HAS_TOOLS -->|是| EXEC_TOOL[执行工具函数]
    EXEC_TOOL --> CALL
    HAS_TOOLS -->|否| RETURN[返回文本结果]

    style SELECT fill:#e3f2fd
    style CALL fill:#fff3e0
```

---

## 8. 前端组件交互流程

### 8.1 分析页面交互

```mermaid
graph TD
    PAGE[分析页面加载] --> FETCH_CONFIG[获取 LLM 配置]
    FETCH_CONFIG --> SHOW_FORM[显示分析表单]

    SHOW_FORM --> USER_INPUT[用户输入股票代码]
    USER_INPUT --> SEARCH[搜索股票信息]
    SEARCH --> SHOW_INFO[显示股票基本信息]

    SHOW_INFO --> CONFIGURE[用户配置分析参数<br/>LLM/辩论轮数/数据源]
    CONFIGURE --> SUBMIT[点击开始分析]

    SUBMIT --> API_CALL[调用分析 API]
    API_CALL --> SSE_CONNECT[建立 SSE 连接<br/>订阅实时进度]

    SSE_CONNECT --> PROGRESS[显示分析进度条]

    subgraph "实时进度更新"
        PROGRESS --> P1[数据采集中...]
        P1 --> P2[分析师分析中...]
        P2 --> P3[研究员辩论中...]
        P3 --> P4[风险评估中...]
        P4 --> P5[生成决策中...]
    end

    P5 --> COMPLETE[分析完成]
    COMPLETE --> SHOW_RESULT[展示分析结果]

    SHOW_RESULT --> TAB_MARKET[技术面报告]
    SHOW_RESULT --> TAB_FUND[基本面报告]
    SHOW_RESULT --> TAB_NEWS[新闻报告]
    SHOW_RESULT --> TAB_SENT[情绪报告]
    SHOW_RESULT --> TAB_DECIDE[最终决策]
    SHOW_RESULT --> EXPORT[导出报告按钮]

    style SUBMIT fill:#e3f2fd
    style COMPLETE fill:#e8f5e9
```

---

## 9. 错误处理流程

```mermaid
graph TD
    ERR[异常发生] --> TYPE{异常类型?}

    TYPE -->|数据源异常| DS_ERR[数据源错误处理]
    TYPE -->|LLM调用异常| LLM_ERR[LLM错误处理]
    TYPE -->|认证异常| AUTH_ERR[认证错误处理]
    TYPE -->|参数异常| PARAM_ERR[参数错误处理]
    TYPE -->|系统异常| SYS_ERR[系统错误处理]

    DS_ERR --> DS_FALLBACK[自动降级到备选数据源]
    DS_FALLBACK --> DS_CHECK{降级成功?}
    DS_CHECK -->|是| CONTINUE[继续业务流程]
    DS_CHECK -->|否| DS_FAIL[返回 502 错误]

    LLM_ERR --> LLM_RETRY[重试 3 次]
    LLM_RETRY --> LLM_CHECK{重试成功?}
    LLM_CHECK -->|是| CONTINUE
    LLM_CHECK -->|否| LLM_FAIL[返回 503 错误]

    AUTH_ERR --> AUTH_401[返回 401 未授权]
    PARAM_ERR --> PARAM_422[返回 422 参数错误]

    SYS_ERR --> LOG[记录错误日志]
    LOG --> SYS_500[返回 500 内部错误]

    style DS_ERR fill:#fff3e0
    style LLM_ERR fill:#e3f2fd
    style AUTH_ERR fill:#ffcdd2
    style SYS_ERR fill:#f3e5f5
```

---

## 10. 系统启动流程

```mermaid
graph TD
    START([Docker Compose Up]) --> MONGO[启动 MongoDB]
    START --> REDIS[启动 Redis]

    MONGO --> MONGO_INIT[MongoDB 初始化<br/>创建索引/默认数据]
    REDIS --> REDIS_INIT[Redis 初始化<br/>清理过期缓存]

    MONGO_INIT --> BACKEND[启动 Backend]
    REDIS_INIT --> BACKEND

    BACKEND --> LOAD_ENV[加载环境变量]
    LOAD_ENV --> INIT_DB[初始化数据库连接池]
    INIT_DB --> INIT_REDIS[初始化 Redis 连接池]
    INIT_REDIS --> INIT_MW[注册中间件]
    INIT_MW --> INIT_ROUTES[注册路由]
    INIT_ROUTES --> INIT_SCHED[启动定时任务调度器]
    INIT_SCHED --> BACKEND_READY[Backend 就绪<br/>监听 :8000]

    BACKEND_READY --> FRONTEND[启动 Frontend]
    FRONTEND --> NGINX[Nginx 启动<br/>监听 :3000]
    NGINX --> PROXY[配置反向代理<br/>/api → Backend:8000]
    PROXY --> SYSTEM_READY[系统就绪]

    style START fill:#e3f2fd
    style SYSTEM_READY fill:#e8f5e9
```
