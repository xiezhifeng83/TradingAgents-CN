# TradingAgents-CN 技术架构文档

> **文档版本**: v1.0
> **项目版本**: v1.0.0-preview
> **编制日期**: 2026-02-11

---

## 1. 架构概览

### 1.1 架构风格

TradingAgents-CN 采用 **分层微服务化单体架构**，核心特征：

- **分层设计**：表现层 → API层 → 服务层 → 核心层 → 数据层 → 基础设施层
- **模块解耦**：核心框架(`tradingagents/`)与Web应用(`app/`+`frontend/`)独立
- **插件化扩展**：数据源、LLM引擎通过适配器模式插拔

### 1.2 架构全景图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            客户端层                                     │
│                                                                         │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐             │
│   │   浏览器      │    │   CLI终端     │    │  第三方调用   │             │
│   │   (Vue 3)    │    │  (Python)    │    │  (REST API)  │             │
│   └──────┬───────┘    └──────┬───────┘    └──────┬───────┘             │
└──────────┼───────────────────┼───────────────────┼─────────────────────┘
           │ HTTPS             │ 直接调用           │ HTTPS
┌──────────┼───────────────────┼───────────────────┼─────────────────────┐
│          ▼                   │                   ▼                      │
│   ┌──────────────┐           │            ┌──────────────┐             │
│   │   Nginx      │           │            │  FastAPI      │             │
│   │   反向代理    │──────────────────────→│  应用服务器    │             │
│   └──────────────┘           │            └──────┬───────┘             │
│                              │                   │                      │
│                     ┌────────┘                   │                      │
│                     │                            │                      │
│              ┌──────▼────────────────────────────▼──────────┐          │
│              │         TradingAgents 核心框架                │          │
│              │                                              │          │
│              │  ┌──────────┐  ┌──────────┐  ┌──────────┐  │          │
│              │  │ LangGraph│  │ Agents   │  │ Dataflows│  │          │
│              │  │ 工作流    │  │ 智能体群  │  │ 数据管道  │  │          │
│              │  └──────────┘  └──────────┘  └──────────┘  │          │
│              │                                              │          │
│              │  ┌──────────┐  ┌──────────┐  ┌──────────┐  │          │
│              │  │ LLM      │  │ Config   │  │ Utils    │  │          │
│              │  │ 适配器    │  │ 配置管理  │  │ 工具集   │  │          │
│              │  └──────────┘  └──────────┘  └──────────┘  │          │
│              └──────────────────────────────────────────────┘          │
│                         │              │              │                 │
│                         ▼              ▼              ▼                 │
│              ┌──────────────┐ ┌──────────────┐ ┌──────────────┐       │
│              │   MongoDB    │ │    Redis     │ │  文件系统     │       │
│              │   持久存储    │ │   缓存服务   │ │  本地缓存     │       │
│              └──────────────┘ └──────────────┘ └──────────────┘       │
│                                                                        │
│                              服务端层                                   │
└────────────────────────────────────────────────────────────────────────┘
           │                    │                    │
           ▼                    ▼                    ▼
┌──────────────────────────────────────────────────────────────────────┐
│                          外部服务层                                   │
│                                                                      │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐   │
│  │ OpenAI API │  │ DeepSeek   │  │ Google AI  │  │ 阿里百炼    │   │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘   │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐   │
│  │ Tushare    │  │ AKShare    │  │ YFinance   │  │ FinnHub    │   │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘   │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 2. 核心组件架构

### 2.1 多智能体编排引擎

**技术选型**: LangGraph (LangChain 生态)

**架构特点**:
- 基于有向无环图 (DAG) + 条件循环的工作流
- 共享状态 (`AgentState`) 传递上下文
- 支持并行节点执行
- 内置检查点 (Checkpoint) 支持断点续传

**组件关系**:

```
TradingAgentsGraph (tradingagents/graph/trading_graph.py)
├── 初始化: _init_llm_clients()     → 创建 LLM 实例
├── 构建: _build_graph()             → 定义节点和边
│   ├── setup.py                     → 图结构配置
│   ├── conditional_logic.py         → 条件分支
│   └── propagation.py               → 传播逻辑
├── 执行: propagate()                → 前向传播
├── 学习: reflect()                  → 反思学习
└── 输出: signal_processing.py       → 信号处理
```

### 2.2 数据管道架构

**设计模式**: 门面模式 + 策略模式 + 装饰器模式

```
DataInterface (门面)
├── DataSourceManager (策略选择)
│   ├── ChinaProviders
│   │   ├── TushareProvider
│   │   ├── AKShareProvider
│   │   └── BaoStockProvider
│   ├── HKProviders
│   │   ├── AKShareHKProvider
│   │   ├── YFinanceProvider
│   │   └── FinnHubProvider
│   └── USProviders
│       ├── YFinanceProvider
│       ├── FinnHubProvider
│       └── AlphaVantageProvider
│
└── IntegratedCache (装饰器/多层)
    ├── RedisCache (L1)
    ├── MongoDBCache (L2)
    └── FileCache (L3)
```

### 2.3 LLM 适配器架构

**设计模式**: 适配器模式 + 工厂模式

```
LLM 适配器体系
├── OpenAICompatibleBase (基类)
│   ├── init_chat_model()       → 创建 ChatOpenAI 实例
│   ├── invoke()                → 标准推理调用
│   └── bind_tools()            → 工具绑定
│
├── DeepSeekAdapter (extends Base)
│   └── 特殊参数: temperature, top_p
│
├── DashScopeAdapter (extends Base)
│   └── 特殊参数: DashScope 兼容格式
│
├── GoogleAdapter (extends Base)
│   └── 特殊参数: Gemini 工具调用格式
│
└── 工厂方法: create_llm_client(provider, config)
    → 根据 provider 类型返回对应适配器实例
```

---

## 3. 后端服务架构

### 3.1 FastAPI 应用结构

```
app/
├── main.py                     # 应用入口，中间件注册，路由挂载
├── core/                       # 核心基础设施
│   ├── config.py               # Pydantic Settings 配置
│   ├── database.py             # MongoDB 连接管理 (Motor)
│   ├── redis_client.py         # Redis 连接管理
│   ├── logging_config.py       # 日志配置
│   └── unified_config.py       # 统一配置入口
├── routers/                    # API 路由层 (Controller)
├── services/                   # 业务逻辑层 (Service)
├── models/                     # 数据模型层 (Model)
├── schemas/                    # 请求/响应模式 (DTO)
├── middleware/                 # 中间件
├── worker/                     # 后台任务工作器
└── constants/                  # 常量定义
```

### 3.2 请求处理管道

```
HTTP Request
  → CORS Middleware
  → Rate Limit Middleware
  → Auth Middleware (JWT验证)
  → Operation Log Middleware (审计日志)
  → Router (路由分发)
  → Service (业务逻辑)
  → Repository (数据访问)
  → Response
  → Error Handler Middleware (异常捕获)
HTTP Response
```

### 3.3 异步任务架构

```
分析请求 → 创建任务记录 → 加入 asyncio.Queue
                                    ↓
                          QueueService (消费者)
                                    ↓
                          AnalysisService.execute()
                                    ↓
                          TradingAgentsGraph.propagate()
                                    ↓
                          结果写入 MongoDB
                                    ↓
                          WebSocket/SSE 通知前端
```

---

## 4. 前端架构

### 4.1 技术架构

```
Vue 3 (Composition API)
├── Vite                   # 构建与开发服务器
├── Vue Router             # 客户端路由
├── Pinia                  # 状态管理
├── Element Plus           # UI 组件库
├── Axios                  # HTTP 客户端
├── ECharts                # 数据可视化
└── TypeScript             # 类型安全
```

### 4.2 目录结构

```
frontend/src/
├── api/                   # API 客户端封装
│   ├── analysis.ts        # 分析接口
│   ├── stocks.ts          # 股票接口
│   ├── config.ts          # 配置接口
│   ├── auth.ts            # 认证接口
│   └── ...
├── components/            # 可复用组件
├── views/                 # 页面视图
├── router/                # 路由定义
├── stores/                # Pinia 状态管理
├── types/                 # TypeScript 类型定义
├── utils/                 # 工具函数
├── App.vue                # 根组件
└── main.ts                # 应用入口
```

### 4.3 数据流

```
用户操作 → View Component → Pinia Store → API Client → Backend
    ↑                                                      │
    └──────────── UI 更新 ← Store 状态变更 ← API 响应 ←───┘
```

---

## 5. 数据库架构

### 5.1 MongoDB 设计

**连接配置**:
- 连接池：最大100，最小10
- 异步驱动：Motor (asyncio)
- 超时：连接5s，操作30s

**集合索引设计**:

| 集合 | 索引 | 类型 |
|------|------|------|
| users | `username` | 唯一索引 |
| users | `email` | 唯一索引 |
| analysis_tasks | `user_id, created_at` | 复合索引 |
| analysis_tasks | `ticker, status` | 复合索引 |
| stocks | `code` | 唯一索引 |
| stocks | `market, industry` | 复合索引 |
| operation_logs | `created_at` | TTL索引 (30天) |

### 5.2 Redis 设计

**连接配置**:
- 连接池：最大20
- 序列化：JSON
- 默认TTL：根据数据类型动态设定

**数据分区**:
- DB 0：应用数据缓存
- DB 1：会话管理
- DB 2：速率限制计数器

---

## 6. 安全架构

### 6.1 认证与授权

```
┌─────────────────────────────────────────────┐
│              安全层级                         │
│                                             │
│  L1: 传输安全    HTTPS / TLS               │
│  L2: 认证       JWT Token (HS256)          │
│  L3: 授权       基于角色的访问控制 (RBAC)   │
│  L4: 输入验证    Pydantic Schema 验证      │
│  L5: 速率限制    IP 级别请求频率控制        │
│  L6: 审计日志    全量操作日志记录           │
└─────────────────────────────────────────────┘
```

### 6.2 敏感数据管理

| 数据类型 | 保护措施 |
|---------|---------|
| 用户密码 | bcrypt 哈希（不可逆） |
| API Key | 环境变量存储，不入版本库 |
| JWT Secret | 环境变量，HS256签名 |
| 数据库密码 | Docker Secret / 环境变量 |

---

## 7. 部署架构

### 7.1 Docker 容器编排

```yaml
# 服务拓扑
services:
  frontend:     # Vue 3 + Nginx (Port: 3000)
    depends_on: [backend]

  backend:      # FastAPI + Uvicorn (Port: 8000)
    depends_on: [mongodb, redis]

  mongodb:      # MongoDB 7.0 (Port: 27017)
    volumes: [mongodb_data]

  redis:        # Redis 7.2 (Port: 6379)
    volumes: [redis_data]
```

### 7.2 网络拓扑

```
外部网络
  │
  ├──→ :3000 (Frontend / Nginx)
  │       │
  │       ├──→ 静态文件服务 (Vue SPA)
  │       └──→ /api/* 反向代理 → :8000 (Backend)
  │
内部网络 (Docker Bridge)
  │
  ├── Backend ←──→ MongoDB (:27017)
  ├── Backend ←──→ Redis (:6379)
  └── Backend ←──→ 外部API (LLM/数据源)
```

### 7.3 多架构支持

- **amd64**: x86_64 服务器 / 个人电脑
- **arm64**: Apple Silicon Mac / 树莓派 / ARM 服务器

---

## 8. 可扩展性设计

### 8.1 扩展点

| 扩展点 | 扩展方式 | 位置 |
|--------|---------|------|
| 新增 LLM 引擎 | 继承 `OpenAICompatibleBase` | `llm_adapters/` |
| 新增数据源 | 实现 Provider 接口 | `dataflows/providers/` |
| 新增智能体 | 创建智能体函数 + 注册到图 | `agents/` + `graph/` |
| 新增市场 | 添加市场 Provider 目录 | `dataflows/providers/` |
| 新增报告格式 | 添加导出器 | `app/routers/reports.py` |
| 新增 API 路由 | 创建路由模块 + 注册 | `app/routers/` |

### 8.2 配置化驱动

系统核心行为通过配置驱动而非硬编码：

```python
# 可配置项示例
{
    "llm_provider": "deepseek",          # 切换 LLM 引擎
    "max_debate_rounds": 3,              # 增加辩论深度
    "default_china_data_source": "tushare", # 切换数据源优先级
    "online_news": True,                 # 开关功能模块
}
```

---

## 9. 监控与可观测性

### 9.1 日志体系

| 日志类别 | 输出目标 | 保留策略 |
|---------|---------|---------|
| 应用日志 | 文件 + 控制台 | 按大小轮转 |
| 访问日志 | MongoDB (operation_logs) | 30天 TTL |
| 分析日志 | 文件 | 按日期轮转 |
| 错误日志 | 文件 + 控制台 | 永久保留 |

### 9.2 健康检查

```
GET /health          # 应用健康状态
GET /health/db       # 数据库连接状态
GET /health/redis    # Redis 连接状态
```

---

## 10. 技术决策记录

| 决策 | 选项 | 选择 | 理由 |
|------|------|------|------|
| Web框架 | Django / FastAPI / Flask | FastAPI | 异步支持好，性能高，自动文档 |
| 数据库 | PostgreSQL / MongoDB | MongoDB | 文档型适合灵活的分析结果存储 |
| 缓存 | Memcached / Redis | Redis | 数据结构丰富，支持持久化 |
| AI编排 | AutoGen / CrewAI / LangGraph | LangGraph | LangChain生态完善，图编排灵活 |
| 前端框架 | React / Vue / Svelte | Vue 3 | 学习曲线平缓，中文社区活跃 |
| 状态管理 | Vuex / Pinia | Pinia | Vue 3 官方推荐，TypeScript支持好 |
| 容器化 | K8s / Docker Compose | Docker Compose | 单机部署足够，降低运维复杂度 |
